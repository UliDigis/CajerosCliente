<!doctype html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout('Cajeros automáticos | Banco Forjadores', 'atms', ~{::content})}">

    <th:block th:fragment="content">

        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <h1 class="h4 mb-1">Cajeros automáticos</h1>
                <div class="text-secondary small">Selecciona un cajero para continuar</div>
            </div>

            <!-- ADMIN: recarga masiva -->
            <div sec:authorize="hasRole('ADMIN')">
                <form id="formRecargarTodos" th:action="@{/admin/cajeros/recargar-todos}" method="post">
                    <button class="btn btn-warning" type="button" onclick="confirmRecargarTodos()">
                        <i class="bi bi-cash-stack me-1"></i>Recargar todos
                    </button>
                </form>
            </div>
        </div>

        <div class="row g-3">

            <div class="col-12 col-md-6 col-xl-4" th:each="atm : ${atms}">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start justify-content-between">
                            <div>
                                <div class="fw-bold" th:text="${atm.nombre}">ATM Centro</div>
                                <div class="small text-secondary" th:text="${atm.ubicacion}">Av. Principal 123</div>
                                <div class="small text-secondary">
                                    Código: <span th:text="${atm.codigo}">ATM-001</span>
                                </div>
                            </div>
                            <span class="badge text-bg-light border" th:text="${atm.estado}">ACTIVO</span>
                        </div>

                        <div class="mt-3 d-flex flex-wrap gap-2">

                            <!-- CLIENTE -->
                            <a class="btn btn-primary"
                               sec:authorize="hasRole('CLIENTE')"
                               th:href="@{'/atm/' + ${atm.codigo}}">
                                Seleccionar
                            </a>

                            <!-- ADMIN: botones adicionales -->
                            <div sec:authorize="hasRole('ADMIN')" class="d-flex flex-wrap gap-2">

                                <a class="btn btn-outline-secondary"
                                   th:href="@{'/atm/' + ${atm.codigo}}">
                                    Ver
                                </a>

                                <form class="m-0"
                                      th:id="${'formRecargar_' + atm.codigo}"
                                      th:action="@{'/admin/cajeros/' + ${atm.codigo} + '/recargar'}"
                                      method="post">
                                    <button class="btn btn-outline-warning" type="button"
                                            th:attr="data-codigo=${atm.codigo},data-nombre=${atm.nombre}"
                                            onclick="confirmRecargarUno(this)">
                                        <i class="bi bi-cash-coin me-1"></i>Recargar cajero
                                    </button>
                                </form>

                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div th:if="${param.ok}" class="d-none" id="msgOk" th:text="${param.ok}">OK</div>
        <div th:if="${param.err}" class="d-none" id="msgErr" th:text="${param.err}">ERR</div>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
                                                function confirmRecargarUno(btn) {
                                                    const codigo = btn.getAttribute('data-codigo');
                                                    const nombre = btn.getAttribute('data-nombre');

                                                    Swal.fire({
                                                        title: 'Recargar cajero',
                                                        text: '¿Deseas recargar el cajero "' + nombre + '" (' + codigo + ')?',
                                                        icon: 'warning',
                                                        showCancelButton: true,
                                                        confirmButtonText: 'Sí, recargar',
                                                        cancelButtonText: 'Cancelar'
                                                    }).then((r) => {
                                                        if (!r.isConfirmed)
                                                            return;
                                                        const form = document.getElementById('formRecargar_' + codigo);
                                                        if (form)
                                                            form.submit();
                                                    });
                                                }

                                                function confirmRecargarTodos() {
                                                    Swal.fire({
                                                        title: 'Recargar todos',
                                                        text: '¿Deseas recargar todos los cajeros activos?',
                                                        icon: 'warning',
                                                        showCancelButton: true,
                                                        confirmButtonText: 'Sí, recargar',
                                                        cancelButtonText: 'Cancelar'
                                                    }).then((r) => {
                                                        if (!r.isConfirmed)
                                                            return;
                                                        const form = document.getElementById('formRecargarTodos');
                                                        if (form)
                                                            form.submit();
                                                    });
                                                }

                                                (function showToastFromParams() {
                                                    const ok = document.getElementById('msgOk');
                                                    const err = document.getElementById('msgErr');

                                                    if (ok && ok.textContent) {
                                                        Swal.fire({icon: 'success', title: ok.textContent});
                                                    }
                                                    if (err && err.textContent) {
                                                        Swal.fire({icon: 'error', title: err.textContent});
                                                    }
                                                })();
        </script>

    </th:block>
</html>
