<!doctype html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout('Cajeros automáticos | Banco Forjadores', 'atms', ~{::content})}">

    <th:block th:fragment="content">

        <style>
            .atm-card {
                transition: transform 0.2s, box-shadow 0.2s;
                border: none;
                background: #fff;
            }
            .atm-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
            }
            .status-dot {
                height: 10px;
                width: 10px;
                border-radius: 50%;
                display: inline-block;
            }
            .bg-gradient-primary {
                background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            }
            .receipt-paper {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-bottom: 2px dashed #adb5bd; /* Efecto corte de papel */
                position: relative;
            }
            .pin-input {
                letter-spacing: 5px;
                font-weight: bold;
            }
        </style>

        <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 fw-bold text-dark"><i class="bi bi-bank me-2"></i>Red de Cajeros</h1>
                <p class="text-muted mb-0">Gestiona y opera los cajeros automáticos disponibles.</p>
            </div>

            <div sec:authorize="hasRole('ADMIN')">
                <form id="formRecargarTodos" th:action="@{/admin/cajeros/recargar-todos}" method="post">
                    <button class="btn btn-dark shadow-sm" type="button" onclick="confirmRecargarTodos()">
                        <i class="bi bi-arrow-repeat me-1"></i> Abastecer Toda la Red
                    </button>
                </form>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-12 col-md-6 col-xl-4" th:each="atm : ${atms}">
                <div class="card atm-card shadow-sm h-100" th:attr="data-atm-code=${atm.codigoCajero}">
                    <div class="card-body p-4 d-flex flex-column">

                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="bg-light p-2 rounded-3 text-primary">
                                    <i class="bi bi-cash-coin fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0 fw-bold" th:text="${atm.codigoCajero}">ATM-01</h5>
                                    <small class="text-muted">ID Terminal</small>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-1 bg-light px-2 py-1 rounded-pill border">
                                <span class="status-dot js-atm-status-dot"
                                      th:classappend="${atm.estado == 1 ? 'bg-success' : 'bg-danger'}"></span>
                                <span class="small fw-semibold text-secondary js-atm-status-text"
                                      th:text="${atm.estado == 1 ? 'En Línea' : 'Fuera de Servicio'}">ACTIVO</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <small class="text-secondary text-uppercase fw-semibold" style="font-size: 0.75rem;">Efectivo Disponible</small>
                            <div class="fs-3 fw-bold text-dark js-atm-cash" 
                                 th:text="${'$' + #numbers.formatDecimal(((atm.saldoCentavos != null ? atm.saldoCentavos : 0) / 100.0), 1, 'COMMA', 2, 'POINT')}">$0.00</div>
                        </div>

                        <div class="mt-auto pt-3 border-top d-grid gap-2">

                            <button class="btn btn-primary js-atm-use-btn"
                                    sec:authorize="hasRole('CLIENTE')"
                                    type="button"
                                    th:attr="data-codigo=${atm.codigoCajero},data-saldo=${atm.saldo},data-estado=${atm.estado}"
                                    onclick="openAtmModal(this)"
                                    th:disabled="${atm.estado != 1}">
                                <i class="bi bi-credit-card me-2"></i>Usar Cajero
                            </button>

                            <div sec:authorize="hasRole('ADMIN')" class="d-flex gap-2">
                                <button class="btn btn-outline-primary w-50"
                                        type="button"
                                        th:attr="data-codigo=${atm.codigoCajero},data-saldo=${atm.saldo},data-estado=${atm.estado}"
                                        onclick="openAtmModal(this)">
                                    <i class="bi bi-eye"></i> Ver
                                </button>

                                <form class="w-50 m-0"
                                      th:id="${'formRecargar_' + atm.codigoCajero}"
                                      th:action="@{'/admin/cajeros/' + ${atm.codigoCajero} + '/recargar'}"
                                      method="post">
                                    <button class="btn btn-outline-warning w-100" type="button"
                                            th:attr="data-codigo=${atm.codigoCajero},data-nombre=${'Cajero ' + atm.codigoCajero}"
                                            onclick="confirmRecargarUno(this)">
                                        <i class="bi bi-plus-lg"></i> Recargar
                                    </button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="atmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg overflow-hidden">

                    <div class="modal-header bg-gradient-primary text-white border-0">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-bank2 fs-4"></i>
                            <div>
                                <h5 class="modal-title fw-bold">Banco Forjadores</h5>
                                <div class="small opacity-75">Terminal: <span id="atmCodigoTitle">...</span></div>
                            </div>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="atmHardReset()"></button>
                    </div>

                    <div class="modal-body bg-light p-4">

                        <div class="alert alert-danger d-none shadow-sm border-0" id="atmMsgBox">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i><span id="atmMsgText">Error</span>
                        </div>

                        <div id="atmStepLogin">
                            <div class="text-center mb-4">
                                <h5 class="fw-bold text-dark">Bienvenido</h5>
                                <p class="text-muted small">Inserte sus credenciales para operar</p>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="atmTarjeta" placeholder="0000 0000 0000 0000" maxlength="16" autocomplete="off">
                                <label for="atmTarjeta"><i class="bi bi-credit-card-2-front me-1"></i> Número de Tarjeta</label>
                            </div>

                            <div class="form-floating mb-4">
                                <input type="password" class="form-control pin-input" id="atmNip" placeholder="****" maxlength="4" autocomplete="off">
                                <label for="atmNip"><i class="bi bi-shield-lock me-1"></i> NIP</label>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-lg" type="button" onclick="atmLogin()" id="btnLogin">
                                    Acceder <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                                <button class="btn btn-link text-decoration-none text-muted btn-sm" onclick="atmResetInputs()">Borrar campos</button>
                            </div>
                        </div>

                        <div id="atmStepOperacion" class="d-none">

                            <div class="card border-0 shadow-sm mb-4 bg-white">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="small text-muted text-uppercase fw-bold">Saldo Disponible</div>
                                            <div class="fs-2 fw-bold text-success" id="atmSaldoCuenta">$0.00</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="badge bg-light text-dark border" id="atmUsuarioNombre">Usuario</div>
                                            <div class="small text-muted mt-1" id="atmRolNombre">Rol</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <label class="form-label fw-semibold">¿Cuánto desea retirar?</label>
                            <div class="input-group mb-4">
                                <span class="input-group-text bg-white border-end-0">$</span>
                                <input type="number" class="form-control border-start-0 ps-0 fs-4 fw-bold" id="atmMonto" placeholder="0.00">
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-lg" type="button" onclick="atmRetirar()" id="btnRetirar">
                                    <i class="bi bi-cash-stack me-2"></i>Confirmar Retiro
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="atmLogout()">
                                    Cancelar y Salir
                                </button>
                            </div>
                        </div>

                        <div id="atmRetiroResult" class="d-none animate__animated animate__fadeIn">

                            <div class="text-center mb-3">
                                <div class="text-success fs-1 mb-2"><i class="bi bi-check-circle-fill"></i></div>
                                <h5 class="fw-bold">¡Retiro Exitoso!</h5>
                                <p class="text-muted small">Por favor tome su efectivo y recibo.</p>
                            </div>

                            <div class="receipt-paper p-3 rounded-1 mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted small">Cajero</span>
                                    <span class="fw-bold small" id="atmCajeroRetiro">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted small">Retirado</span>
                                    <span class="fw-bold text-dark" id="atmRetiroMonto">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                                    <span class="text-muted small">Saldo Restante</span>
                                    <span class="fw-bold text-muted" id="atmSaldoRestante">-</span>
                                </div>

                                <div class="small fw-bold mb-2">Desglose de Efectivo:</div>
                                <table class="table table-sm table-borderless mb-0 small">
                                    <tbody id="atmDesgloseBody"></tbody>
                                </table>
                            </div>

                            <div class="d-grid">
                                <button class="btn btn-primary" type="button" onclick="atmHardReset()" data-bs-dismiss="modal">
                                    Finalizar
                                </button>
                            </div>
                        </div>

                    </div>

                    <div class="modal-footer bg-white py-2 justify-content-center">
                        <small class="text-muted" style="font-size: 0.7rem;">
                            <i class="bi bi-lock-fill me-1"></i>Transacción Segura End-to-End
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${param.ok}" class="d-none" id="msgOk" th:text="${param.ok}"></div>
        <div th:if="${param.err}" class="d-none" id="msgErr" th:text="${param.err}"></div>

        <script src="/js/api-client.js?v=2"></script>
        <script>
            let atmModalInstance = null;
            const atmSession = {
                codigoCajero: null,
                tarjeta: null,
                nip: null,
                idCuenta: null,
                atmToken: null
            };

            function openAtmModal(btn) {
                atmSession.codigoCajero = btn.dataset.codigo;
                document.getElementById("atmCodigoTitle").textContent = atmSession.codigoCajero;
                atmHardReset();
                const modalEl = document.getElementById("atmModal");
                atmModalInstance = new bootstrap.Modal(modalEl);
                atmModalInstance.show();
            }

            function atmHardReset() {
                document.getElementById("atmTarjeta").value = "";
                document.getElementById("atmNip").value = "";
                document.getElementById("atmMonto").value = "";
                document.getElementById("atmStepLogin").classList.remove("d-none");
                document.getElementById("atmStepOperacion").classList.add("d-none");
                document.getElementById("atmRetiroResult").classList.add("d-none");
                document.getElementById("atmMsgBox").classList.add("d-none");
                atmSession.tarjeta = null;
                atmSession.nip = null;
                atmSession.idCuenta = null;
                atmSession.atmToken = null;
            }

            function atmLogout() { atmHardReset(); }
            function atmResetInputs() {
                document.getElementById("atmTarjeta").value = "";
                document.getElementById("atmNip").value = "";
                document.getElementById("atmMsgBox").classList.add("d-none");
            }

            function showError(msg) {
                const box = document.getElementById("atmMsgBox");
                document.getElementById("atmMsgText").textContent = msg;
                box.classList.remove("d-none");
            }

            function swalAvailable() {
                return typeof window.Swal !== "undefined" && typeof window.Swal.fire === "function";
            }

            async function swalConfirm(title, text) {
                if (!swalAvailable()) {
                    return confirm(text ? `${title}\n${text}` : title);
                }

                const res = await Swal.fire({
                    icon: "question",
                    title,
                    text: text || undefined,
                    showCancelButton: true,
                    confirmButtonText: "Sí",
                    cancelButtonText: "Cancelar"
                });
                return res.isConfirmed;
            }

            async function swalError(title, text) {
                if (!swalAvailable()) {
                    alert(text || title);
                    return;
                }
                await Swal.fire({icon: "error", title, text});
            }

            async function swalSuccess(title, text) {
                if (!swalAvailable()) {
                    if (text) alert(`${title}\n${text}`); else alert(title);
                    return;
                }
                await Swal.fire({icon: "success", title, text, timer: 1400, showConfirmButton: false});
            }

            function setCashText(el, cents) {
                if (!el) return;
                el.textContent = formatCurrency(cents);
            }

            function applyAtmUpdate(cardEl, atm) {
                if (!cardEl || !atm) return;

                const cashEl = cardEl.querySelector(".js-atm-cash");
                setCashText(cashEl, atm.saldoCentavos);

                const dotEl = cardEl.querySelector(".js-atm-status-dot");
                const textEl = cardEl.querySelector(".js-atm-status-text");

                const online = Number(atm.estado) === 1;
                if (dotEl) {
                    dotEl.classList.toggle("bg-success", online);
                    dotEl.classList.toggle("bg-danger", !online);
                }
                if (textEl) {
                    textEl.textContent = online ? "En Línea" : "Fuera de Servicio";
                }

                // Botón cliente "Usar Cajero"
                const useBtn = cardEl.querySelector(".js-atm-use-btn");
                if (useBtn) {
                    useBtn.disabled = !online;
                    useBtn.dataset.estado = String(atm.estado);
                    if (atm.saldo != null) {
                        useBtn.dataset.saldo = String(atm.saldo);
                    }
                }
            }

            async function refreshAtmCards() {
                try {
                    const res = await getATMs();
                    if (!res.success || !Array.isArray(res.data)) return;

                    res.data.forEach(atm => {
                        const cardEl = document.querySelector(`[data-atm-code="${atm.codigoCajero}"]`);
                        applyAtmUpdate(cardEl, atm);
                    });
                } catch (e) {
                    // Silencioso: es un refresh visual
                    console.error("No se pudo refrescar cajeros:", e);
                }
            }

            async function atmLogin() {
                const tarjeta = document.getElementById("atmTarjeta").value.trim();
                const nip = document.getElementById("atmNip").value.trim();
                document.getElementById("atmMsgBox").classList.add("d-none");

                if (!tarjeta || !nip) {
                    showError("Ingrese tarjeta y NIP.");
                    return;
                }

                const btn = document.getElementById("btnLogin");
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Autenticando...';

                try {
                    const response = await authenticateCard(tarjeta, nip);
                    if (!response.success) {
                        throw new Error(response.error?.message || "Credenciales inválidas");
                    }

                    atmSession.tarjeta = tarjeta;
                    atmSession.nip = nip;
                    atmSession.idCuenta = response.data.cuentaId;
                    atmSession.atmToken = response.data.token;

                    const jwt = decodeJwtPayload(atmSession.atmToken);
                    const displayName = jwt?.nombres
                            || jwt?.nombre
                            || jwt?.correo
                            || jwt?.sub
                            || "Usuario";
                    document.getElementById("atmUsuarioNombre").textContent = displayName;
                    document.getElementById("atmRolNombre").textContent = response.data.rolNombre;

                    const saldoResp = await getBalance(atmSession.idCuenta, atmSession.atmToken);
                    if (!saldoResp.success) {
                        throw new Error(saldoResp.error?.message || saldoResp.error || "No se pudo consultar saldo");
                    }
                    document.getElementById("atmSaldoCuenta").textContent = formatCurrency(saldoResp.data.saldoCentavos);

                    document.getElementById("atmStepLogin").classList.add("d-none");
                    document.getElementById("atmStepOperacion").classList.remove("d-none");
                } catch (e) {
                    showError(e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Acceder <i class="bi bi-arrow-right ms-2"></i>';
                }
            }

            async function atmRetirar() {
                const montoStr = document.getElementById("atmMonto").value;
                const monto = Number(montoStr);

                if (!monto || monto <= 0) {
                    await swalError("Monto inválido", "Ingrese un monto válido mayor a 0.");
                    return;
                }

                const btn = document.getElementById("btnRetirar");
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

                try {
                    const montoCentavos = toCentavos(monto);
                    const response = await withdraw(atmSession.codigoCajero, atmSession.tarjeta, atmSession.nip, montoCentavos, atmSession.atmToken);

                    if (!response.success) {
                        throw new Error(response.error?.message || "Error en el retiro");
                    }

                    document.getElementById("atmRetiroMonto").textContent = formatCurrency(response.data.montoCentavos || montoCentavos);
                    document.getElementById("atmSaldoRestante").textContent = formatCurrency(response.data.saldoRestanteCentavos);
                    document.getElementById("atmCajeroRetiro").textContent = atmSession.codigoCajero;

                    if (response.data.desglose) {
                        const tbody = document.getElementById("atmDesgloseBody");
                        tbody.innerHTML = "";
                        response.data.desglose.forEach(item => {
                            const row = `<tr><td>${formatCurrency(item.valorCentavos)}</td><td class="text-end">x${item.cantidad}</td></tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    }

                    document.getElementById("atmStepOperacion").classList.add("d-none");
                    document.getElementById("atmRetiroResult").classList.remove("d-none");
                    await swalSuccess("Retiro exitoso");

                    // Refrescar saldos de cajeros sin recargar pantalla
                    refreshAtmCards();
                } catch (e) {
                    await swalError("No se pudo retirar", e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cash-stack me-2"></i>Confirmar Retiro';
                }
            }

            async function confirmRecargarUno(btn) {
                const codigo = btn.dataset.codigo;
                const ok = await swalConfirm("¿Recargar cajero?", `¿Recargar el cajero ${codigo}?`);
                if (!ok) return;

                const btn_el = btn;
                btn_el.disabled = true;
                try {
                    const response = await reloadATM(codigo);
                    if (response.success) {
                        await swalSuccess("Cajero recargado");
                        refreshAtmCards();
                    } else {
                        await swalError("Error", response.error?.message || response.error || "No se pudo recargar");
                    }
                } catch (e) {
                    await swalError("Error", e.message);
                } finally {
                    btn_el.disabled = false;
                }
            }

            async function confirmRecargarTodos() {
                const ok = await swalConfirm("¿Recarga masiva?", "¿Recargar TODOS los cajeros?");
                if (!ok) return;

                try {
                    const response = await reloadAllATMs();
                    if (response.success) {
                        await swalSuccess("Recarga masiva completada");
                        refreshAtmCards();
                    } else {
                        await swalError("Error", response.error?.message || response.error || "Error en recarga masiva");
                    }
                } catch (e) {
                    await swalError("Error", e.message);
                }
            }

            // Al cargar la página, sincroniza saldos/estados con el backend sin recargar
            document.addEventListener("DOMContentLoaded", () => {
                refreshAtmCards();
            });
        </script>
    </th:block>
</html>
