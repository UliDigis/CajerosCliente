<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout('Administración | Cajeros & Usuarios', 'dashboard', ~{::content})}">

    <th:block th:fragment="content">

        <style>
            .soft-muted {
                color:#64748b;
            }
            .card-kpi .kpi-ico{
                width: 40px;
                height: 40px;
                border-radius: 14px;
                display:flex;
                align-items:center;
                justify-content:center;
                background: rgba(13,110,253,.10);
                color: #0d6efd;
                flex: 0 0 auto;
            }
            .chart-placeholder{
                height: 260px;
                border-radius: 14px;
                border: 1px dashed rgba(0,0,0,.15);
                background: linear-gradient(180deg, #ffffff, #fbfcff);
                display:flex;
                align-items:center;
                justify-content:center;
                color: #94a3b8;
            }
        </style>

        <div class="alert alert-danger d-flex align-items-center shadow-sm" role="alert" th:if="${errorMessage}">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div th:text="${errorMessage}">Error</div>
        </div>

        <div class="alert alert-success d-flex align-items-center shadow-sm" role="alert" th:if="${successMessage}">
            <i class="bi bi-check-circle-fill me-2"></i>
            <div th:text="${successMessage}">Éxito</div>
        </div>

        <div th:if="${param.ok}" class="alert alert-success d-flex align-items-center shadow-sm">
            <i class="bi bi-check-circle-fill me-2"></i>
            <div th:text="${param.ok}">Operación exitosa</div>
        </div>
        <div th:if="${param.err}" class="alert alert-danger d-flex align-items-center shadow-sm">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div th:text="${param.err}">Error</div>
        </div>

        <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-4">
            <div>
                <h1 class="h4 mb-1">Dashboard</h1>
                <p class="soft-muted mb-0 small">Gestión de red de cajeros y usuarios.</p>
            </div>

            <div sec:authorize="hasRole('ADMIN')">
                <form th:action="@{/admin/cajeros/recargar-todos}" method="post" onsubmit="return confirm('¿Recargar TODOS los cajeros?');">
                    <button class="btn btn-warning text-dark" type="submit">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Recarga Masiva
                    </button>
                </form>
            </div>
        </div>

        <div id="tabsArea" class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom-0 pt-3 px-3 d-flex flex-wrap gap-2 align-items-center justify-content-between">
                <div class="fw-bold text-primary">Panel de Control</div>

                <ul class="nav nav-pills nav-soft gap-1" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-atms" data-bs-toggle="pill" data-bs-target="#pane-atms" type="button" role="tab">
                            <i class="bi bi-bank me-1"></i> Cajeros
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" sec:authorize="hasRole('ADMIN')">
                        <button class="nav-link" id="tab-users" data-bs-toggle="pill" data-bs-target="#pane-users" type="button" role="tab">
                            <i class="bi bi-people me-1"></i> Usuarios
                        </button>
                    </li>
                </ul>
            </div>

            <div class="card-body p-0">
                <div class="tab-content" id="adminTabsContent">

                    <div class="tab-pane fade show active" id="pane-atms" role="tabpanel" tabindex="0">

                        <div class="p-3 border-bottom bg-light bg-opacity-10 d-flex gap-2 justify-content-end">
                            <div class="input-group input-group-sm w-auto">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0" placeholder="Buscar cajero...">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">Código</th>
                                        <th class="text-end">Saldo Actual</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-end pe-4">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${atms == null || #lists.isEmpty(atms)}">
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-hdd-stack fs-1 d-block mb-2"></i>
                                            No hay cajeros registrados
                                        </td>
                                    </tr>

                                    <tr th:each="atm : ${atms}">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width:32px;height:32px">
                                                    <i class="bi bi-bank2 small"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold text-dark" th:text="${atm.codigoCajero}">ATM-001</div>
                                                    <div class="small text-muted" th:text="'ID: ' + ${atm.idCajero}">ID: 1</div>
                                                </div>
                                            </div>
                                        </td>

                                        <td class="text-end font-monospace fw-bold text-dark" 
                                            th:text="${'$' + #numbers.formatDecimal(atm.saldo, 1, 'COMMA', 2, 'POINT')}">
                                            $0.00
                                        </td>

                                        <td class="text-center">
                                            <span class="badge rounded-pill border"
                                                  th:classappend="${atm.estado == 1} ? 'text-bg-success border-success-subtle' : 'text-bg-secondary border-secondary-subtle'">
                                                <i class="bi me-1" th:classappend="${atm.estado == 1} ? 'bi-wifi' : 'bi-wifi-off'"></i>
                                                <span th:text="${atm.estado == 1 ? 'En Línea' : 'Fuera de Servicio'}">ACTIVO</span>
                                            </span>
                                        </td>

                                        <td class="text-end pe-4">
                                            <div class="d-flex justify-content-end gap-2">

                                                <button class="btn btn-sm btn-outline-primary d-flex align-items-center"
                                                        type="button"
                                                        th:disabled="${atm.estado == 0 && !#authorization.expression('hasRole(''ADMIN'')')}"
                                                        onclick="alert('Aquí iría la lógica para abrir el modal del cajero (ver código anterior)')">
                                                    <i class="bi bi-credit-card me-1"></i> Acceder
                                                </button>

                                                <div sec:authorize="hasRole('ADMIN')" class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-success d-flex align-items-center"
                                                            type="button"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#rechargeModal"
                                                            th:attr="data-atm-id=${atm.idCajero},data-atm-code=${atm.codigoCajero},data-atm-balance=${atm.saldo}">
                                                        <i class="bi bi-cash-coin me-1"></i> Recargar
                                                    </button>

                                                    <form th:action="@{'/atms/' + ${atm.codigoCajero} + '/toggle'}" method="post" class="m-0">
                                                        <button class="btn btn-sm border" 
                                                                th:classappend="${atm.estado == 1} ? 'btn-light text-danger' : 'btn-light text-success'"
                                                                type="submit"
                                                                th:title="${atm.estado == 1} ? 'Apagar' : 'Encender'">
                                                            <i class="bi" th:classappend="${atm.estado == 1} ? 'bi-power' : 'bi-play-fill'"></i>
                                                        </button>
                                                    </form>
                                                </div>

                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pane-users" role="tabpanel" tabindex="0">
                        <div class="p-5 text-center text-muted">
                            <i class="bi bi-people fs-1"></i>
                            <p class="mt-2">Gestión de usuarios disponible próximamente.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="text-center small soft-muted mt-4">
            &copy; <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2026</span> Banco Forjadores — Panel Administrativo
        </div>

        <div class="modal fade" id="rechargeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title"><i class="bi bi-cash-stack me-2"></i>Recargar Cajero</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>

                    <form th:action="@{/atms/__codigo__/recargar}" method="post" id="rechargeForm">
                        <div class="modal-body">
                            <div class="alert alert-info d-flex align-items-center p-2 mb-3">
                                <i class="bi bi-info-circle me-2 fs-4"></i>
                                <div class="small">
                                    Esta acción reestablecerá los billetes según la <strong>Plantilla Estándar</strong> definida en BD.
                                </div>
                            </div>

                            <div class="mb-3 text-center">
                                <div class="small text-muted text-uppercase fw-bold">Cajero Seleccionado</div>
                                <div class="fs-4 fw-bold text-primary" id="atmCodeLabel">---</div>
                                <div class="small text-muted">Saldo actual: $<span id="atmBalanceLabel">0.00</span></div>
                            </div>
                        </div>
                        <div class="modal-footer border-top-0">
                            <button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4">
                                Confirmar Recarga
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="/js/api-client.js"></script>
        <script>
            // Cargar lista de cajeros por AJAX
            async function loadATMs() {
                try {
                    const response = await getATMs();
                    if (response.success && response.data) {
                        const tbody = document.querySelector('table tbody');
                        tbody.innerHTML = '';
                        response.data.forEach(atm => {
                            const row = `
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width:32px;height:32px">
                                                <i class="bi bi-bank2 small"></i>
                                            </div>
                                            <div>
                                                <div class="fw-semibold text-dark">${atm.codigoCajero}</div>
                                                <div class="small text-muted">ID: ${atm.idCajero}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end font-monospace fw-bold text-dark">${formatCurrency(atm.saldoCentavos)}</td>
                                    <td class="text-center">
                                        <span class="badge rounded-pill border ${atm.estado === 1 ? 'text-bg-success border-success-subtle' : 'text-bg-secondary border-secondary-subtle'}">
                                            <i class="bi me-1 ${atm.estado === 1 ? 'bi-wifi' : 'bi-wifi-off'}"></i>
                                            ${atm.estado === 1 ? 'En Línea' : 'Fuera de Servicio'}
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-outline-warning" onclick="rechargeATM('${atm.codigoCajero}', ${atm.saldoCentavos})">
                                            <i class="bi bi-cash-coin me-1"></i> Recargar
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    }
                } catch (e) {
                    console.error('Error cargando cajeros:', e);
                }
            }

            async function rechargeATM(codigo, saldo) {
                if (!confirm(`¿Recargar el cajero ${codigo}?`)) return;

                try {
                    const response = await reloadATM(codigo);
                    if (response.success) {
                        alert('Cajero recargado exitosamente');
                        loadATMs();
                    } else {
                        alert('Error: ' + (response.error?.message || 'No se pudo recargar'));
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            }

            // Cargar al iniciar página
            document.addEventListener('DOMContentLoaded', loadATMs);
        </script>

    </th:block>
</html>